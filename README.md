# Installation and setup

Create virtual env


```
cd cdse-downloader

virtualenv -p python3 .venv

source .venv/bin/activate

pip install -r requirements.txt
```
# Setup and runnning 

## Download products by area

Create a configturation file like the following

*s2-england-luigi.cfg*

```
[Core]


[DownloadProductsByArea]
mission = Sentinel2
geoFilter = Intersects(POLYGON((-1.213619303149454 50.84007494841458,0.0892367134668721 50.84007494841458,0.0892367134668721 51.82135325292194,-1.213619303149454 51.82135325292194,-1.213619303149454 50.84007494841458)))
stateLocation = /state
s3configLocation = s3cfg
downloadLocation = /downloads
s2CloudCover = 95
s3ConfigLocation = /workflowFolder/s3cfg
```

This creates a configuation file that will retrieve S2 products that intersect with the specified geospatial location. The data will be downloaded to /downloads and the state files generated by each task in the workflow will be saved in /state.

AccessKeyId and SecretKey are the S3 access credentials for the CDSE s3 bucket

All of the options can be overridden on the command line. Removing an option from the config file mandates that it be supplied on the command line.

Specify the date rane on the command line with the *startDate* and *endDate* parameters. Note that these parameters have a time dimension.

```
LUIGI_CONFIG_PATH=s2-england-luigi.cfg PYTHONPATH='.' luigi --module cdse_downloader DownloadProductsByArea --startDate=2019-07-06T0000 --endDate=2019-07-08T1200 --local-scheduler
```

### Luigi Arguments
    --mission
        senitnal1 or sentinal2
    --startDate         
        Start date of date range as ISO datetime format YYYY-MM-DDThhmmss
    --endDate           
        End date of date range as ISO datetime format YYYY-MM-DDThhmmss
    --orbitDirection    
        ASCENDING or DESCENDING filter (for use with S1 primarily)
    --productLevel      
        Product level, for S1 `L1_`, for S2 `L1C`
    --productType       
        Product type of data we are trying to collect, for S1 (GRD|SLC|RAW)


    Sentinel 1 arguments
    --s1RelativeOrbitNo
        The relative orbit number of the orbit you want to filter on i.e. 125
    --s1Polarisation 
        The polorisation of the data (optional) (VV&VH|HH&HV|VV|HH)
    --s1ProcessingLevel
        The processing level (optional)
    --s1SensorMode
        The S1 sensor mode

    Sentinel 2 arguments         
    --s2CloudCover      
        Maximum cloudcover as a percentage
    


## Download a list of products

Create a configturation file like the following

*s2-list-luigi.cfg*

```
[Core]

[DownloadProductsFromList]
mission = Sentinel2
stateLocation = /state
s3configLocation = s3cfg
downloadLocation = /downloads
accessKeyId =  access-key
secretKey = secret-key
s3ConfigLocation = /workflowFolder/s3cfg
```

This configuration file will retreive a list of S2 products. Note the configuration file is specific to a platform becuae the downloader needs to get additional info about each product from a specific mundi api end point. Therefore using an S2 configuration to download S1, and vice versa, will fail.

This configuration file will store downloads in /downloads and state in /state

Creat a list of the products you want to download like so:

*productlist.txt*

```
S2B_MSIL1C_20190930T113319_N0208_R080_T30VVH_20190930T133803
S2B_MSIL1C_20190930T113319_N0208_R080_T30UWG_20190930T133803
S2B_MSIL1C_20190930T113319_N0208_R080_T30UWF_20190930T133803
S2B_MSIL1C_20190930T113319_N0208_R080_T30UVD_20190930T133803
```

Specifiy the product list file on the command line using *productListFile*. This option could be moved into the configuration file if you have standard input file names.

```
LUIGI_CONFIG_PATH=s2-list-luigi.cfg  PYTHONPATH='.' luigi --module mundi_downloader DownloadProductsFromList --productListFile=productlist.txt --local-scheduler
```

## Create a csv of available products by area

Create a configturation file like the following

*s2-england-luigi.cfg*

```
[Core]


[GenerateReport]
endPoint = Sentinel2
geoFilter = Intersects(POLYGON((-1.213619303149454 50.84007494841458,0.0892367134668721 50.84007494841458,0.0892367134668721 51.82135325292194,-1.213619303149454 51.82135325292194,-1.213619303149454 50.84007494841458)))
dateField = sensingStartDate
stateLocation = /state
s2CloudCover = 95
```

This creates a configuation file that will retrieve S2 products that intersect with the specified geospatial location. The state files generated by each task in the workflow will be saved in /state.

All of the options can be overridden on the command line. Removing an option from the config file mandates that it be supplied on the command line.

Specify the date range on the command line with the *startDate* and *endDate* parameters. Note that these parameters have a time dimension.

Specify the report file with the *reportFile* paramter 

```
LUIGI_CONFIG_PATH=s2-england-luigi.cfg PYTHONPATH='.' luigi --module mundi_downloader GenerateReport --startDate=2019-07-06T0000 --endDate=2019-07-08T1200 --reportFile=test-report.csv --local-scheduler
```

This will generate a report file "test-report.csv" that lists the products avaialbe from the mundi portal that meet the specified parameters.

Note that the GenerateReport task does not write any files to the state folder. The report file itself is the the state file.

